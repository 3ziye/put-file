# 文件服务器架构文档

本文档介绍文件服务器项目的整体架构设计、模块划分和各组件之间的关系，帮助开发者理解项目结构和工作原理。

## 项目架构概述

文件服务器采用典型的Go语言Web应用架构，遵循关注点分离原则，将功能划分为多个独立的模块。整体架构如下：

```
┌─────────────────────────────────────┐
│             HTTP 层                 │
│  (cmd/server/main.go - 路由处理)    │
└───────────────┬─────────────────────┘
                │
┌───────────────┼─────────────────────┐
│               │                     │
▼               ▼                     ▼
┌───────────┐ ┌───────────┐ ┌────────────────┐
│   处理层   │ │  认证层   │ │    配置层      │
│ handlers  │ │   auth    │ │    config      │
└─────┬─────┘ └───────────┘ └────────────────┘
      │
      │
      ▼
┌───────────┐ ┌───────────┐ ┌───────────┐
│   模型层   │ │   工具层   │ │   日志层   │
│  models   │ │   utils   │ │   logs    │
└───────────┘ └───────────┘ └───────────┘
```

## 目录结构详解

项目采用标准的Go项目目录结构，主要包含以下几个部分：

### cmd/server/

应用程序的入口点，包含`main.go`文件，负责：
- 解析命令行参数和环境变量
- 加载配置文件
- 初始化各个组件
- 设置HTTP路由和中间件
- 启动Web服务器

### internal/

内部包目录，包含项目的核心功能实现。根据Go语言的惯例，这些包不会被外部项目导入。

#### internal/auth/

实现身份验证相关功能，主要包含：

#### internal/logs/

实现统一的日志系统，支持不同日志级别和文件输出，主要包含：
- Logger 接口定义
- 日志级别控制
- 日志输出格式化

#### internal/models/

定义数据模型和结构，主要包含：
- Basic认证中间件
- 用户凭据验证功能

#### internal/config/

负责配置加载和管理，支持从多种来源读取配置：
- 配置文件（JSON格式）
- 环境变量
- 命令行参数

#### internal/handlers/

实现HTTP请求处理程序，处理各种HTTP请求：
- Web界面文件上传
- API接口处理（登录、文件上传、文件列表、文件删除）
- 统一的API响应处理

#### internal/models/

定义数据模型，包含项目中使用的各种结构体：
- User：用户模型
- APIResponse：统一的API响应格式
- FileInfo：文件信息模型

#### internal/utils/

提供通用的工具函数，如目录创建等基础功能。

### tests/

包含项目的测试文件，用于验证各个组件的功能。

### doc/

包含项目的文档，如API文档、架构文档等。

## 核心流程

### 1. 服务器启动流程

1. 解析命令行参数
2. 加载配置文件
3. 应用环境变量覆盖配置
4. 应用命令行参数覆盖配置
5. 初始化用户信息
6. 确保上传目录存在
7. 创建认证中间件
8. 设置HTTP路由
9. 启动Web服务器

### 2. 文件上传流程

#### Web界面上传
1. 用户访问上传页面
2. 选择文件并点击上传按钮
3. 服务器接收文件并保存到指定目录
4. 返回上传成功页面

#### API上传
1. 客户端发送带有Basic认证的POST请求
2. 认证中间件验证用户凭据
3. 服务器接收文件并保存到指定目录
4. 返回JSON格式的响应

### 3. 文件访问流程

1. 用户通过浏览器访问文件URL（/files/文件名）
2. 服务器查找并返回对应的文件
3. 如果文件不存在，返回404错误

## 配置管理

文件服务器支持三级配置优先级：
1. 命令行参数（最高优先级）
2. 环境变量
3. 配置文件
4. 默认配置（最低优先级）

这种设计使得用户可以根据自己的需求灵活地配置服务器，既可以通过配置文件进行持久化配置，也可以通过环境变量或命令行参数进行临时配置。

## 安全考虑

1. **身份验证**：API接口使用Basic认证保护，防止未授权访问
2. **权限控制**：目前实现了简单的基于用户名和密码的访问控制
3. **文件大小限制**：上传文件大小限制为10MB，可以在代码中调整
4. **路径安全**：使用`filepath.Join`和标准库函数处理文件路径，防止路径遍历攻击

## 扩展性考虑

项目的模块化设计使其具有良好的扩展性，可以方便地添加新功能：

1. **添加新的API接口**：只需在`internal/handlers/`目录下添加新的处理函数，并在`main.go`中注册路由
2. **修改认证方式**：可以扩展`internal/auth/`包，实现更复杂的认证方式
3. **添加新的配置项**：只需在`internal/config/config.go`中的Config结构体中添加新字段，并在相关代码中使用

## 性能优化

1. **静态文件服务**：使用Go标准库的`http.FileServer`处理静态文件，性能良好
2. **内存限制**：解析multipart/form-data时设置了内存限制，防止内存溢出
3. **并发处理**：Go的HTTP服务器默认支持并发处理请求，无需额外配置

## 监控与维护

目前项目提供了基本的日志输出，可以在启动时看到服务器监听地址、根目录等信息。对于生产环境，可以考虑添加更完善的日志系统和监控机制。